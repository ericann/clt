<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="../resources/css/generic.css" type="text/css" />

	<script type="text/javascript" src="../resources/js/manage.js"></script>
	<script type="text/javascript" src="../resources/js/Ajax.js"></script>
</head>
<body>
	<div class="head">
		<div class="icon_buttons"><button class="top_menu"></button></div>
		<!-- <div class="menu"></div> -->
		<div class="prompt">CLT Management</div>
		<div class="special">v2.0</div>
	</div>
	
	
	
	<script>
		clt.init();
		
		clt.currentPage = {
			/* ua: "19fcfbca-b71a-4708-a38c-beaa8ea71d8b",
			ca: "891acad4-50d7-46d8-95ec-3d3171b734f6",
			id: "49d026f9-6638-414b-a976-bd5ad93c4933", */
			name: "Management",
			metadata: {},
			data: {},
			profile: {},
			menu: {}
		}
		
		Ajax.get({
			url:"http://localhost:8080/clt/security/profile/", 
			type: "GET",
			headers: {"CLT-ACCESS-TOKEN": sessionStorage.getItem("CLT-ACCESS-TOKEN")},
			success: function(result) {
				clt.currentPage.profile = JSON.parse(result);
				var menu = convertMenu(clt.currentPage.profile);
				showMenu(menu);
		}});
		
		function convertMenu(profileStr) {
			/*
			var menu = (typeof menuStr === "string" ? JSON.parse(menuStr) : menuStr);
			
			var profile = {};
			for(var i = 0; i < menu.length; i++) {
				profile["uaId"] = menu[i]["uaId"];
				profile["caId"] = menu[i]["caId"];
				
				profile["menu"] = profile["menu"] ? profile["menu"] : {};
			
				if(!profile["menu"][menu[i]["m_name"]]) {
					profile["menu"][menu[i]["m_name"]] = {};
					profile["menu"][menu[i]["m_name"]]["id"] = menu[i]["m_id"];
					profile["menu"][menu[i]["m_name"]]["name"] = menu[i]["m_name"];
				}
				
				if(!profile["menu"][menu[i]["m_name"]]["objects"]) {
					console.log("-- objects is null");
					profile["menu"][menu[i]["m_name"]]["objects"] = {};
				}
				
				if(menu[i]["op_name"]) {
					profile["menu"][menu[i]["m_name"]]["objects"][menu[i]["op_name"]] = menu[i]["opId"];
					Ajax.get({
						url: "http://localhost:8080/clt/metadata-api/FieldPermission/" + menu[i]["opId"] + "/all",
						headers: [{"key": "CLT-Access-Token", "value": sessionStorage.getItem("CLT-Access-Token")}],
						type: "GET", 
						success: function(result) {
							var metas = JSON.parse(result);
							if(metas["objectName"]) {
								clt.metadata[metas["objectName"]] = metas;
							}
						}
					});
				}
				
			}
			*/
			var profile = (typeof profileStr === "string" ? JSON.parse(profileStr) : profileStr),
				uaAndCa = getUaAndCa(profile),
				menu_ = profile[uaAndCa[0]][uaAndCa[1]],
				menu = {},
				keys = Object.keys(menu_);
			for(var i = 0; i < keys.length; i++) {
				var menuItem = menu_[keys[i]],
					objs = menuItem["objects"],
					objNames = Object.keys(objs);
				
				menu[menuItem.name] = menuItem;
				
				if(!objs) {
					continue;
				}
				
				for(var j = 0; j < objNames.length; j++) {
					Ajax.get({
						url: "http://localhost:8080/clt/metadata-api/FieldPermission/" + objs[objNames[j]] + "/all",
						headers: {"CLT-ACCESS-TOKEN": sessionStorage.getItem("CLT-ACCESS-TOKEN")},
						type: "GET", 
						success: function(result) {
							var metas = JSON.parse(result);
							if(metas["objectName"]) {
								clt.currentPage.metadata[metas["objectName"]] = metas;
							}
						}
					});
				}
			}
			
			return defaultMenuData(menu);
		}
		
		function showMenu(data) {
			clt.currentPage.menu = data;
			
			var objs = {
				title: "Menu",
				buttons: [],
				fields: [],
				classname: "menu",
			};
			
			var keys = Object.keys(data);
			
			for(var i = 0; i < keys.length; i++) {
				
				var obj = {};
				obj = {
					label: "$",
					type: "a",
					default: keys[i]
				}
				objs.fields.push(obj);
			}
			
			var h = clt.template.createSection(objs);
			h.style.display = "none";
			document.body.appendChild(h);
			document.getElementsByClassName("top_menu")[0].addEventListener(
					"click", 
					function() {
						document.getElementsByClassName("menu")[0].style.display = "block";
					}, 
					false);		
			menuItemEvent();
		}
		
		function menuItemEvent() {
			var a = document.getElementsByClassName("menu")[0].getElementsByClassName("f_values");
			for(var i = 0; i < a.length; i++) {
				a[i].getElementsByTagName("a")[0].addEventListener("click", function(e) {
					e = e || e.target;
					
					var sections = document.getElementsByClassName("section");
					for(var i = sections.length - 1; i >= 0; i--) {
						document.body.removeChild(sections[i]);
					}
					
					var objs = clt.currentPage.menu[e.target.innerText].objects;
					var keys = Object.keys(objs);
					for(var i = 0; i < keys.length; i++) {
						
						var obj = {
							title: keys[i],
							fields: [{
								label: "waiting",
								type: "img",
								default: "http://localhost:8080/clt/resources/images/loading.gif",
								defaultAction: showListService
							}],
							buttons: [],
							style: "f"
						};

						document.body.appendChild(clt.template.createSection(obj));
					}
					
					document.getElementsByClassName("menu")[0].style.display = "none";
				}, false);
				
				if(a[i].getElementsByTagName("a")[0].innerText == "Management") {
					a[i].getElementsByTagName("a")[0].click();
				}
			}
		}
		
		function showListService(e) {
			e = e || e.target;
			var parent = e.parentElement.parentElement.parentElement.parentElement.parentElement;
			var content_ = parent.getElementsByClassName("content")[0];
			var objectName = parent.getElementsByClassName("default")[0].innerHTML;
			
			if((clt.currentPage.data[objectName] && clt.currentPage.data[objectName].length)) {
				updateShowList(parent, clt.currentPage.data[objectName]);
			} else if (Object.prototype.toString.call(clt.currentPage.data[objectName]) === "[object Object]") {
				showFormService(parent, clt.currentPage.data[objectName]);
			} else {
			
				Ajax.get({
					url:"http://localhost:8080/clt/data-api/" + objectName + "/", 
					type: "POST", 
					headers: {"CLT-ACCESS-TOKEN": sessionStorage.getItem("CLT-ACCESS-TOKEN")},
					success: function(result) {
						var objs = JSON.parse(result);
						updateShowList(parent, objs, objectName);
					}
				});
			}
		}
		
		//need override
		function showFormService(parent, data) {
			var fields = data.length ? createAllRows(data) : defaultNoData(data);
				content = clt.template.createContent(fields, "f"),
	            content_ = parent.getElementsByClassName("content")[0],
	            content_.innerHTML = "";
	        
	        for(var i = 0; i < content.length; i++) {
	            content_.appendChild(content[i]);
	        }
		}
		
		//List object
        function updateShowList(parent, data, objectName) {
            
            clt.currentPage.data[objectName] = data;    
            parent.getElementsByClassName("row_count")[0].innerHTML = data.length;
            
            var fields = data.length ? createAllRows(data) : defaultNoData();
                
                content = clt.template.createContent(fields, data.length ? "t" : "f"),
                content_ = parent.getElementsByClassName("content")[0],
                content_.innerHTML = "";
            
            for(var i = 0; i < content.length; i++) {
                content_.appendChild(content[i]);
            }
        }
        
        //single object
        function createObjectHeader(headers, data) {
            var rowHeader = [];
            
            for(var i = 0; i < headers.length; i++) {
            	//��ʱ����1:n ����ʾ
            	if(typeof data[headers[i]] === "object") {
            		continue;
            	}
            	
                var o = {
                    label: headers[i],
                    default: headers[i],
                    type: "div",
                    isHeader: true
                };
                rowHeader.push(o);
            }
            
            return rowHeader;
        }
        
        //single object
        function createObjectRows(data, keys) {
            var fields = [];
            
            for(var i = 0; i < data.length; i++) {
                var rowBody = [];
                for(var j = 0; j < keys.length; j++) {
                	//��ʱ����1:n ����ʾ
                	if(typeof data[i][keys[j]] === "object") {
                		continue;
                	}
                	
                    var o = {
                        label: keys[j],
                        default: data[i][keys[j]],
                        type: typeof data[i][keys[j]] === "object" ? "a" : "div",
                        display: typeof data[i][keys[j]] === "object" ? "a" : "div"
                    };
                    rowBody.push(o);
                }
                fields.push(rowBody);
            }
            
            return fields;
        }
        
        function createAllRows(data) {
        	var keys = Object.keys(data[0]),
        		fields = [createObjectHeader(keys, data[0])],
        		rowBody_ = createObjectRows(data, keys);
        	
        	for(var i = 0; i < rowBody_.length; i++) {
        		fields.push(rowBody_[i]);
        	}
        	
        	return fields;
        }
        
        function defaultNoData(data) {
        	var obj = {
        		label: "reminder",
        		default: "Here is no data or you have no permissions.",
        		type: "div"
        	}
        	
        	return [data ? data : obj];
        }
        
        function defaultMenuData(menu) {
        	menu["Management"].objects = {
        		"Management": null		
        	};
        	
        	clt.currentPage.data.Management = {
        		label : "Welcome",
        		default : "Welcome to CLT v2.0 Management!",
        		type: "div"
        	}
        	
        	return menu;
        }
        
        function getUaAndCa(profile) {
        	var uaAndCa = [];
        	var keys = Object.keys(profile);
        	for(var i = 0; i < keys.length; i++) {
        		if(keys[i].length == 36) {
        			uaAndCa.push(keys[i]);
        			break;
        		}
        	}
        	uaAndCa.push(Object.keys(profile[uaAndCa[0]])[0]);
        	return uaAndCa;
        }
	</script>
</body>
</html>
